<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <title>Звіт про Місячний Дохід (Plotly)</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; background-color: #f4f7f9; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; background: #fff; padding: 30px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); }
        h1 { color: #333; text-align: center; margin-bottom: 30px; }
        .kpi-container { display: flex; justify-content: space-around; margin-bottom: 30px; }
        .kpi-card { background: #e0f7fa; border-left: 5px solid #00bcd4; padding: 15px; border-radius: 4px; text-align: center; flex: 1; margin: 0 10px; }
        .kpi-card h3 { margin: 0 0 5px; font-size: 1.1em; color: #00796b; }
        .kpi-value { font-size: 2em; font-weight: bold; color: #00bcd4; }
        .controls { display: flex; justify-content: center; gap: 20px; margin-bottom: 30px; padding: 15px; background: #fafafa; border-radius: 4px; }
        .controls label { font-weight: bold; color: #555; }
        .controls input[type="date"] { padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
        .controls button { padding: 8px 15px; background-color: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer; transition: background-color 0.3s; }
        .controls button:hover { background-color: #45a049; }
        .chart-container { height: 400px; }
    </style>
</head>
<body>

    <div class="container">
        <h1 id="report-title">Звіт про Місячний Дохід (Завантаження...)</h1>

        <div class="controls">
            <div>
                <label for="start_date">Початкова дата:</label>
                <input type="date" id="start_date" value="2023-01-01">
            </div>
            <div>
                <label for="end_date">Кінцева дата:</label>
                <input type="date" id="end_date" value="2024-12-31">
            </div>
            <button onclick="fetchDataAndRender()">Оновити</button>
        </div>

        <div class="kpi-container">
            <div class="kpi-card">
                <h3>Загальний Дохід за Період</h3>
                <div id="kpi-total-revenue" class="kpi-value">...</div>
            </div>
            <div class="kpi-card">
                <h3>Середній Місячний Дохід</h3>
                <div id="kpi-mean-monthly" class="kpi-value">...</div>
            </div>
            <div class="kpi-card">
                <h3>Макс. Місячний Дохід</h3>
                <div id="kpi-max-monthly" class="kpi-value">...</div>
            </div>
            <div class="kpi-card">
                <h3>Місяців у Звіті</h3>
                <div id="kpi-months-count" class="kpi-value">...</div>
            </div>
        </div>

        <div class="chart-container">
            <div id="revenueChart"></div>
        </div>
    </div>

    <script>
        const API_BASE_URL = 'http://127.0.0.1:8000/api/reports/';

        const monthNames = [
            "Січ", "Лют", "Бер", "Кві", "Тра", "Чер",
            "Лип", "Сер", "Вер", "Жов", "Лис", "Гру"
        ];

        function formatCurrency(amount) {
            return new Intl.NumberFormat('uk-UA', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: 2
            }).format(amount);
        }

        async function fetchDataAndRender() {
            const startDate = document.getElementById('start_date').value;
            const endDate = document.getElementById('end_date').value;
            const endpoint = `${API_BASE_URL}monthly-revenue/?start_date=${startDate}&end_date=${endDate}`;

            document.getElementById('report-title').innerText = "Завантаження...";

            try {
                const response = await fetch(endpoint);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();

                document.getElementById('report-title').innerText = data.report_name;

                updateKPIs(data.analytics_stats);

                const chartData = prepareChartData(data.time_series_data);

                renderChart(chartData.labels, chartData.revenues, data.time_series_data);

            } catch (error) {
                console.error("Помилка завантаження даних:", error);
                document.getElementById('report-title').innerText = `Помилка завантаження: ${error.message}`;
                updateKPIs({});
                renderChart([], [], []);
            }
        }

        function prepareChartData(seriesData) {
            const labels = [];
            const revenues = [];

            const dates = [];

            seriesData.sort((a, b) => {
                if (a.order_year !== b.order_year) {
                    return a.order_year - b.order_year;
                }
                return a.order_month - b.order_month;
            });

            seriesData.forEach(item => {
                const label = `${monthNames[item.order_month - 1]} ${item.order_year}`;
                labels.push(label);
                revenues.push(parseFloat(item.total_revenue));

                const dateString = `${item.order_year}-${String(item.order_month).padStart(2, '0')}-01`;
                dates.push(dateString);
            });

            return { labels, revenues, dates };
        }

        function updateKPIs(stats) {
            const totalRevenue = stats.total_period_revenue || 0;
            const meanMonthly = stats.mean_monthly_revenue || 0;
            const maxMonthly = stats.max_monthly_revenue || 0;
            const monthsCount = stats.months_in_report || 0;

            document.getElementById('kpi-total-revenue').innerText = formatCurrency(totalRevenue);
            document.getElementById('kpi-mean-monthly').innerText = formatCurrency(meanMonthly);
            document.getElementById('kpi-max-monthly').innerText = formatCurrency(maxMonthly);
            document.getElementById('kpi-months-count').innerText = monthsCount;
        }

        function renderChart(labels, data, fullData) {
            const chartDiv = document.getElementById('revenueChart');

            const trace = {
                x: prepareChartData(fullData).dates,
                y: data,
                mode: 'lines+markers',
                name: 'Місячний Дохід',
                line: {
                    color: '#00bcd4',
                    shape: 'spline'
                },
                fill: 'to zero',
                fillcolor: 'rgba(0, 188, 212, 0.2)',

                hovertemplate:
                    '<b>Місяць:</b> %{x|%Y %b}<br>' +
                    '<b>Дохід:</b> %{y:$.2f}' +
                    '<extra></extra>'
            };

            const plotData = [trace];

            const layout = {
                title: 'Динаміка Місячного Доходу',
                xaxis: {
                    title: 'Дата',
                    type: 'date',
                    rangeselector: {
                        buttons: [
                            { step: 'month', stepmode: 'backward', count: 6, label: '6 міс' },
                            { step: 'year', stepmode: 'backward', count: 1, label: '1 рік' },
                            { step: 'all', label: 'Весь час' }
                        ]
                    }
                },
                yaxis: {
                    title: 'Дохід ($)',
                    tickprefix: '$',
                    zeroline: true
                },
                margin: { t: 50, b: 50 },
                height: 400
            };

            Plotly.newPlot(chartDiv, plotData, layout, {
                responsive: true,
                displayModeBar: false
            });
        }

        window.onload = fetchDataAndRender;
    </script>
</body>
</html>