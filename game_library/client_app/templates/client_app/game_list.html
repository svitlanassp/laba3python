{% extends 'client_app/base.html' %}
{% load static %}

{% block title %}–ú–∞–≥–∞–∑–∏–Ω —ñ–≥–æ—Ä{% endblock %}

{% block content %}
    <div class="container">

        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; border-bottom: 2px solid #eee; padding-bottom: 20px;">

            <div style="font-size: 1.5rem; font-weight: 900; color: #2c3e50;">
               üéÆ GameLib
            </div>

            <div style="display: flex; align-items: center; gap: 15px;">

                <div class="balance-trigger" onclick="openModal()" title="–ù–∞—Ç–∏—Å–Ω—ñ—Ç—å, —â–æ–± –ø–æ–ø–æ–≤–Ω–∏—Ç–∏">
                    üí∞ {{ balance|default:"0.00" }} $
                    <span style="font-size: 0.8em; opacity: 0.7;">(+)</span>
                </div>

                <a href="{% url 'library' %}" class="btn btn-secondary" style="font-size: 0.9rem; padding: 8px 15px;">
                    üìö –ú–æ—ó —ñ–≥—Ä–∏
                </a>

                <div style="border-left: 1px solid #ccc; padding-left: 15px; display: flex; align-items: center; gap: 10px;">
                    <span style="color: #636e72;">
                        <strong>{{ user.username }}</strong>
                    </span>
                    <form action="{% url 'logout' %}" method="post" style="margin: 0;">
                        {% csrf_token %}
                        <button type="submit" class="btn" style="color: #95a5a6; background: none; padding: 0; text-decoration: underline;">
                            –í–∏–π—Ç–∏
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <div class="filter-panel">
            <form method="get" action="{% url 'game_list' %}">

                <div class="search-row">
                    <input type="text" name="q" placeholder="üîç –í–≤–µ–¥—ñ—Ç—å –Ω–∞–∑–≤—É –≥—Ä–∏..." value="{{ request.GET.q }}" class="search-input">

                    <button type="submit" class="btn btn-primary">–ó–Ω–∞–π—Ç–∏</button>

                    {% if request.GET.q or request.GET.developer or request.GET.publisher or request.GET.genre %}
                        <a href="{% url 'game_list' %}" class="btn btn-secondary">–°–∫–∏–Ω—É—Ç–∏</a>
                    {% endif %}
                </div>

                <div class="filters-row">
                    <select name="developer" class="filter-select">
                        <option value="">-- –í—Å—ñ —Ä–æ–∑—Ä–æ–±–Ω–∏–∫–∏ --</option>
                        {% for dev in developers %}
                            <option value="{{ dev.pk }}" {% if request.GET.developer == dev.pk|stringformat:"s" %}selected{% endif %}>
                                {{ dev.name }}
                            </option>
                        {% endfor %}
                    </select>

                    <select name="publisher" class="filter-select">
                        <option value="">-- –í—Å—ñ –≤–∏–¥–∞–≤—Ü—ñ --</option>
                        {% for pub in publishers %}
                            <option value="{{ pub.pk }}" {% if request.GET.publisher == pub.pk|stringformat:"s" %}selected{% endif %}>
                                {{ pub.name }}
                            </option>
                        {% endfor %}
                    </select>

                    <select name="genre" class="filter-select">
                        <option value="">-- –í—Å—ñ –∂–∞–Ω—Ä–∏ --</option>
                        {% for g in genres %}
                            <option value="{{ g.pk }}" {% if request.GET.genre == g.pk|stringformat:"s" %}selected{% endif %}>
                                {{ g.name }}
                            </option>
                        {% endfor %}
                    </select>
                </div>

            </form>
        </div>

        {% if messages %}
            <div class="messages-container">
                {% for message in messages %}
                    <div class="alert alert-{{ message.tags }}">
                        <span>
                            {% if message.tags == 'error' %}‚õî{% elif message.tags == 'success' %}‚úÖ{% else %}‚ö†Ô∏è{% endif %}
                            {{ message }}
                        </span>
                        <span style="cursor: pointer; opacity: 0.6;" onclick="this.parentElement.style.display='none';">&times;</span>
                    </div>
                {% endfor %}
            </div>
        {% endif %}

        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
            <h1 style="margin: 0; border: none;">–ú–∞–≥–∞–∑–∏–Ω</h1>
            <a href="{% url 'game_create' %}" class="btn btn-primary">‚ûï –î–æ–¥–∞—Ç–∏ –≥—Ä—É</a>
        </div>

        <ul class="game-list">
            {% for game in games %}
                <li class="game-card">
                    <div>
                        <a href="{% url 'game_detail' pk=game.pk %}" class="game-title">{{ game.title }}</a>
                        <div style="color: #7f8c8d; font-size: 0.9em; margin-bottom: 8px;">
                            {{ game.developer|default:"–ù–µ–≤—ñ–¥–æ–º–∏–π —Ä–æ–∑—Ä–æ–±–Ω–∏–∫" }}
                        </div>
                        <div style="font-size: 0.85em; color: #3498db">
                            {% for genre in game.genre.all|slice:":3" %}
                                #{{ genre.name }}
                            {% endfor %}
                        </div>
                    </div>

                    <div class="game-price" style="display: flex; justify-content: space-between; align-items: center; margin-top: 10px;">
                        <span>{{ game.price }} $</span>

                        {% if game in user.library.games.all %}
                            <span style="color: #27ae60; font-weight: bold; font-size: 0.9rem;">‚úî –ü—Ä–∏–¥–±–∞–Ω–æ</span>

                        {% elif user.library.balance < game.price %}
                            <button class="btn" style="background-color: #bdc3c7; cursor: not-allowed; font-size: 0.8rem; padding: 5px 15px;" disabled title="–ù–µ –≤–∏—Å—Ç–∞—á–∞—î –∫–æ—à—Ç—ñ–≤">
                                –©–µ {{ game.price|add:"-"|add:user.library.balance }} $
                            </button>

                        {% else %}
                            <a href="{% url 'buy_game' pk=game.pk %}" class="btn btn-primary" style="padding: 5px 15px; font-size: 0.8rem;">
                                –ö—É–ø–∏—Ç–∏
                            </a>
                        {% endif %}
                    </div>
                </li>
            {% empty %}
                <p>–Ü–≥–æ—Ä –Ω–µ–º–∞—î.</p>
            {% endfor %}
        </ul>
    </div>

    <div id="moneyModal" class="modal-overlay">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal()">&times;</span>

            <h2 style="margin-bottom: 20px; color: #2c3e50;">–ü–æ–ø–æ–≤–Ω–µ–Ω–Ω—è</h2>

            <form action="{% url 'top_up' %}" method="post">
                {% csrf_token %}
                <label style="text-align: left;">–í–≤–µ–¥—ñ—Ç—å —Å—É–º—É:</label>
                <input type="number" name="amount" placeholder="100.00" required style="margin-bottom: 20px; font-size: 1.2rem; text-align: center;">

                <button type="submit" class="btn btn-primary" style="width: 100%; font-size: 1.1rem;">
                    üí≥ –ü–æ–ø–æ–≤–Ω–∏—Ç–∏ —Ä–∞—Ö—É–Ω–æ–∫
                </button>
            </form>
        </div>
    </div>

    <script>
        var modal = document.getElementById("moneyModal");
        function openModal() {
            modal.style.display = "block";
        }
        function closeModal() {
            modal.style.display = "none";
        }
        window.onclick = function(event) {
            if (event.target == modal) {
                modal.style.display = "none";
            }
        }
    </script>

{% endblock %}