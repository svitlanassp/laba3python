<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <title>Звіт: Топ Ігор за Рейтингом (Plotly)</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; background-color: #f4f7f9; padding: 20px; }
        .container { max-width: 1400px; margin: 0 auto; background: #fff; padding: 30px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); }
        h1 { color: #333; text-align: center; margin-bottom: 30px; }
        .kpi-container { display: flex; justify-content: space-around; margin-bottom: 30px; }
        .kpi-card { background: #fff3e0; border-left: 5px solid #ff9800; padding: 15px; border-radius: 4px; text-align: center; flex: 1; margin: 0 10px; }
        .kpi-card h3 { margin: 0 0 5px; font-size: 1.1em; color: #e65100; }
        .kpi-value { font-size: 2em; font-weight: bold; color: #ff9800; }
        .controls { display: flex; flex-wrap: wrap; justify-content: center; gap: 20px; margin-bottom: 30px; padding: 15px; background: #fafafa; border-radius: 4px; }
        .controls label { font-weight: bold; color: #555; }
        .controls input, .controls select { padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
        .controls button { padding: 8px 15px; background-color: #ff9800; color: white; border: none; border-radius: 4px; cursor: pointer; transition: background-color 0.3s; }
        .controls button:hover { background-color: #e65100; }
        .chart-grid { display: grid; grid-template-columns: 1.5fr 1fr; gap: 20px; }
        .chart-container { height: 400px; }
    </style>
</head>
<body>

    <div class="container">
        <h1 id="report-title">Звіт: Топ Ігор за Рейтингом (Завантаження...)</h1>

        <div class="controls">
            <div>
                <label for="min_reviews">Мін. Відгуків:</label>
                <input type="number" id="min_reviews" value="10" min="1">
            </div>
            <div>
                <label for="genre_name">Жанр (опц.):</label>
                <select id="genre_name">
                    <option value="">Всі Жанри</option>
                </select>
            </div>
            <div>
                <label for="min_price">Мін. Ціна:</label>
                <input type="number" id="min_price" min="0" step="0.01" placeholder="0">
            </div>
            <div>
                <label for="max_price">Макс. Ціна:</label>
                <input type="number" id="max_price" min="0" step="0.01" placeholder="50">
            </div>
            <button onclick="fetchDataAndRender()">Завантажити</button>
        </div>

        <div class="kpi-container">
            <div class="kpi-card">
                <h3>Ігор у Звіті</h3>
                <div id="kpi-total-games" class="kpi-value">...</div>
            </div>
            <div class="kpi-card">
                <h3>Середній Рейтинг</h3>
                <div id="kpi-mean-rating" class="kpi-value">...</div>
            </div>
            <div class="kpi-card">
                <h3>Медіана Рейтингу</h3>
                <div id="kpi-median-rating" class="kpi-value">...</div>
            </div>
            <div class="kpi-card">
                <h3>Загальна Кількість Відгуків</h3>
                <div id="kpi-total-reviews" class="kpi-value">...</div>
            </div>
            <div class="kpi-card">
                <h3>Середня Ціна</h3>
                <div id="kpi-mean-price" class="kpi-value">...</div>
            </div>
        </div>

        <div class="chart-grid">
            <div class="chart-container">
                <div id="ratingChart"></div>
            </div>
            <div class="chart-container">
                <div id="pricePieChart"></div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE_URL = 'http://127.0.0.1:8000/api/reports/';
        const ALL_GENRES = [
            "Action", "RPG", "Strategy", "Simulation", "Puzzle",
            "Horror", "Sports", "Adventure", "Indie", "MMO", "Platformer",
            "Survival", "Rogue-like"
        ];
        function populateGenreDropdown() {
            const selectElement = document.getElementById('genre_name');

            ALL_GENRES.forEach(genre => {
                const option = document.createElement('option');
                option.value = genre;
                option.textContent = genre;
                selectElement.appendChild(option);
            });
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('uk-UA', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: 2
            }).format(amount);
        }

        async function fetchDataAndRender() {
            const minReviews = document.getElementById('min_reviews').value;
            const genreName = document.getElementById('genre_name').value;
            const minPrice = document.getElementById('min_price').value;
            const maxPrice = document.getElementById('max_price').value;

            const params = new URLSearchParams({
                min_reviews: minReviews,
                genre: genreName,
                min_price: minPrice,
                max_price: maxPrice
            });

            const endpoint = `${API_BASE_URL}top-rated-games/?${params.toString()}`;

            document.getElementById('report-title').innerText = "Завантаження...";
            updateKPIs({});

            try {
                const response = await fetch(endpoint);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();

                document.getElementById('report-title').innerText = data.report_name;

                updateKPIs(data.analytics_stats);

                const chartData = prepareChartData(data.time_series_data);

                renderRatingChart(chartData.titles, chartData.ratings);
                renderPricePieChart(chartData.prices);

            } catch (error) {
                console.error("Помилка завантаження даних:", error);
                document.getElementById('report-title').innerText = `Помилка завантаження: ${error.message}`;
            }
        }

        function prepareChartData(seriesData) {
            const top10 = seriesData.slice(0, 10);

            const titles = top10.map(item => item.title);
            const ratings = top10.map(item => parseFloat(item.avg_rating).toFixed(2));
            const prices = top10.map(item => parseFloat(item.price));

            return { titles, ratings, prices };
        }

        function updateKPIs(stats) {
            const totalGames = stats.total_games_in_report || 0;
            const meanRating = (stats.mean_avg_rating || 0).toFixed(2);
            const medianRating = (stats.median_avg_rating || 0).toFixed(2);
            const totalReviews = stats.total_reviews || 0;
            const meanPrice = stats.mean_price || 0;

            document.getElementById('kpi-total-games').innerText = totalGames;
            document.getElementById('kpi-mean-rating').innerText = meanRating;
            document.getElementById('kpi-median-rating').innerText = medianRating;
            document.getElementById('kpi-total-reviews').innerText = totalReviews.toLocaleString('uk-UA');
            document.getElementById('kpi-mean-price').innerText = formatCurrency(meanPrice);
        }

        function renderRatingChart(titles, ratings) {
            const trace = {
                x: titles,
                y: ratings,
                type: 'bar',
                name: 'Середній Рейтинг',
                marker: { color: 'rgba(255, 152, 0, 0.8)' },
                hovertemplate: '<b>Гра:</b> %{x}<br><b>Рейтинг:</b> %{y}'
            };
            const layout = {
                title: 'Топ-10 Ігор за Середнім Рейтингом',
                yaxis: { title: 'Рейтинг (1.0-5.0)', range: [3.0, 5.0] },
                xaxis: { title: 'Гра', automargin: true },
                margin: { t: 50, b: 150 },
            };
            Plotly.newPlot('ratingChart', [trace], layout, { responsive: true, displayModeBar: false });
        }

        function renderPricePieChart(prices) {
            const priceBins = {
                'Дешеві ($10.00 - $25.00)': 0,
                'Середні ($25.01 - $50.00)': 0,
                'Дорогі (>$50.00)': 0
            };

            const paidPrices = prices.filter(price => price > 0);

            paidPrices.forEach(price => {
                if (price <= 25) {
                    priceBins['Дешеві ($10.00 - $25.00)']++;
                } else if (price <= 50) {
                    priceBins['Середні ($25.01 - $50.00)']++;
                } else {
                    priceBins['Дорогі (>$50.00)']++;
                }
            });

            const labels = [];
            const values = [];

            for (const [label, count] of Object.entries(priceBins)) {
                if (count > 0) {
                    labels.push(label);
                    values.push(count);
                }
            }

            if (values.length === 0) {
                Plotly.purge('pricePieChart');
                return;
            }

            const data = [{
                values: values,
                labels: labels,
                type: 'pie',
                hole: .4,
                hovertemplate: '%{label}<br><b>Кількість:</b> %{value} (%{percent})<extra></extra>'
            }];

            const layout = {
                title: 'Ціновий Розподіл (Платні Ігри у Топ-10)',
                margin: { t: 50, b: 50, l: 50, r: 50 }
            };

            Plotly.newPlot('pricePieChart', data, layout, { responsive: true, displayModeBar: false });
        }

        window.onload = () => {
            populateGenreDropdown();
            fetchDataAndRender();
        };
    </script>
</body>
</html>