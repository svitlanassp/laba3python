<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <title>–Ü–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∏–π –ê–Ω–∞–ª—ñ—Ç–∏—á–Ω–∏–π –î–∞—à–±–æ—Ä–¥ V1</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; background-color: #f4f7f9; padding: 20px; }
        .container { max-width: 1700px; margin: 0 auto; background: #fff; padding: 30px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); }
        h1 { color: #333; text-align: center; margin-bottom: 30px; }
        .controls-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px; margin-bottom: 30px; padding: 15px; background: #fafafa; border-radius: 4px;
        }
        .controls-grid div { display: flex; flex-direction: column; }
        .controls-grid label { font-weight: bold; color: #555; margin-bottom: 5px;}
        .controls-grid input, .controls-grid select { padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
        .controls-grid button { padding: 8px 15px; background-color: #00bcd4; color: white; border: none; border-radius: 4px; cursor: pointer; transition: background-color 0.3s; margin-top: auto; }
        .controls-grid button:hover { background-color: #00acc1; }

        .chart-layout {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
        }
        .chart-box {
            background: #fff;
            padding: 10px;
            border: 1px solid #eee;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }
        .chart-container { height: 400px; }
    </style>
</head>
<body>

    <div class="container">
        <h1>üìä –Ü–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∏–π –ê–Ω–∞–ª—ñ—Ç–∏—á–Ω–∏–π –î–∞—à–±–æ—Ä–¥ (v1)</h1>

        <div class="controls-grid">
            <div><label for="start_date">–ú—ñ—Å—è—á–Ω–∏–π –î–æ—Ö—ñ–¥ (–ó):</label><input type="date" id="start_date"></div>
            <div><label for="end_date">–ú—ñ—Å—è—á–Ω–∏–π –î–æ—Ö—ñ–¥ (–î–æ):</label><input type="date" id="end_date"></div>
            <div><label for="year_filter">–†—ñ–∫ (–î–æ—Ö—ñ–¥/–í–∏—Ç—Ä–∞—Ç–∏):</label><input type="number" id="year_filter" placeholder="–†—ñ–∫" min="2020"></div>
            <div><label for="top_n_filter">Top N (–†–æ–∑—Ä./–ê–∫—Ç–∏–≤.):</label><input type="number" id="top_n_filter" value="10" min="1"></div>
            <div><label for="min_playtime">–ú—ñ–Ω. –ß–∞—Å –ì—Ä–∏ (–≥–æ–¥):</label><input type="number" id="min_playtime" value="0" min="0"></div>

            <div><label for="min_games_count">–ú—ñ–Ω. –Ü–≥–æ—Ä —É –ñ–∞–Ω—Ä—ñ:</label><input type="number" id="min_games_count" value="5" min="1"></div>

            <div><label for="trg_genre_name">–ñ–∞–Ω—Ä (–¢–æ–ø –Ü–≥–æ—Ä):</label><select id="trg_genre_name"><option value="">–í—Å—ñ –ñ–∞–Ω—Ä–∏</option></select></div>
            <div><label for="min_reviews">–ú—ñ–Ω. –í—ñ–¥–≥—É–∫—ñ–≤:</label><input type="number" id="min_reviews" value="10" min="1"></div>
            <div><label for="min_price">–ú—ñ–Ω. –¶—ñ–Ω–∞:</label><input type="number" id="min_price" min="0" step="0.01" placeholder="0"></div>
            <div><label for="max_price">–ú–∞–∫—Å. –¶—ñ–Ω–∞:</label><input type="number" id="max_price" min="0" step="0.01" placeholder="50"></div>

            <button onclick="fetchAllDataAndRender()">–û–Ω–æ–≤–∏—Ç–∏ –í—Å—ñ –ì—Ä–∞—Ñ—ñ–∫–∏</button>
        </div>

        <div class="chart-layout">
            <div class="chart-box"><h3 style="text-align: center;">1. –ú—ñ—Å—è—á–Ω–∏–π –î–æ—Ö—ñ–¥</h3><div class="chart-container" id="chart-monthly-revenue"></div></div>
            <div class="chart-box"><h3 style="text-align: center;">2. –¢–æ–ø –†–æ–∑—Ä–æ–±–Ω–∏–∫—ñ–≤ –∑–∞ –î–æ—Ö–æ–¥–æ–º</h3><div class="chart-container" id="chart-dev-revenue"></div></div>
            <div class="chart-box"><h3 style="text-align: center;">3a. –ê–Ω–∞–ª—ñ–∑ "–ö–∏—Ç—ñ–≤" (–í–∏—Ç—Ä–∞—Ç–∏)</h3><div class="chart-container" id="chart-whales-spending"></div></div>
            <div class="chart-box"><h3 style="text-align: center;">3b. –ê–Ω–∞–ª—ñ–∑ "–ö–∏—Ç—ñ–≤" (–†–æ–∑–±–∏–≤–∫–∞ –ñ–∞–Ω—Ä—ñ–≤)</h3><div class="chart-container" id="chart-whales-genre"></div></div>
            <div class="chart-box"><h3 style="text-align: center;">4. –ê–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤</h3><div class="chart-container" id="chart-user-activity"></div></div>
            <div class="chart-box"><h3 style="text-align: center;">5. –°–µ—Ä–µ–¥–Ω—ñ–π –ß–∞—Å –ì—Ä–∏ –∑–∞ –ñ–∞–Ω—Ä–∞–º–∏</h3><div class="chart-container" id="chart-genre-playtime"></div></div>

            <div class="chart-box"><h3 style="text-align: center;">6a. –¢–æ–ø –Ü–≥–æ—Ä –∑–∞ –†–µ–π—Ç–∏–Ω–≥–æ–º</h3><div class="chart-container" id="chart-top-rated-ranking"></div></div>
            <div class="chart-box"><h3 style="text-align: center;">6b. –¶—ñ–Ω–æ–≤–∏–π –†–æ–∑–ø–æ–¥—ñ–ª –¢–æ–ø –Ü–≥–æ—Ä</h3><div class="chart-container" id="chart-top-rated-price"></div></div>
        </div>
    </div>

    <script>
        const API_BASE_URL = 'http://127.0.0.1:8000/api/reports/';

        const ALL_GENRES = [
            "Action", "RPG", "Strategy", "Simulation", "Puzzle",
            "Horror", "Sports", "Adventure", "Indie", "MMO", "Platformer",
            "Survival", "Rogue-like"
        ];

        function formatCurrency(amount) {
            return new Intl.NumberFormat('uk-UA', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: 2
            }).format(amount);
        }
        function populateGenreDropdown() {
            const selectElement = document.getElementById('trg_genre_name');
            ALL_GENRES.forEach(genre => {
                const option = document.createElement('option');
                option.value = genre;
                option.textContent = genre;
                selectElement.appendChild(option);
            });
        }

        async function fetchAllDataAndRender() {
            const year = document.getElementById('year_filter').value;
            const topN = document.getElementById('top_n_filter').value;
            const startDate = document.getElementById('start_date').value;
            const endDate = document.getElementById('end_date').value;
            const minGames = document.getElementById('min_games_count').value;
            const minPlaytime = document.getElementById('min_playtime').value;

            const minReviews = document.getElementById('min_reviews').value;
            const trgGenre = document.getElementById('trg_genre_name').value;
            const minPrice = document.getElementById('min_price').value;
            const maxPrice = document.getElementById('max_price').value;


            renderMonthlyRevenueChart(startDate, endDate);
            renderDeveloperRevenueChart(year, topN);
            renderWhalesCharts(year, topN);
            renderUserActivityChart(minPlaytime, topN);
            renderGenrePlaytimeChart(minGames);

            renderTopRatedGamesCharts(minReviews, trgGenre, minPrice, maxPrice, topN);
        }

        // 1. –ú—ñ—Å—è—á–Ω–∏–π –î–æ—Ö—ñ–¥
        async function renderMonthlyRevenueChart(startDate, endDate) {
            const params = new URLSearchParams({ start_date: startDate, end_date: endDate });
            const endpoint = `${API_BASE_URL}monthly-revenue/?${params.toString()}`;

            document.getElementById('chart-monthly-revenue').innerHTML = '';

            try {
                const response = await fetch(endpoint);
                const data = await response.json();

                const chartData = data.time_series_data.map(d => ({
                    date: `${d.order_year}-${String(d.order_month).padStart(2, '0')}-01`,
                    revenue: parseFloat(d.total_revenue)
                }));

                const trace = {
                    x: chartData.map(d => d.date),
                    y: chartData.map(d => d.revenue),
                    mode: 'lines+markers',
                    type: 'scatter',
                    name: '–î–æ—Ö—ñ–¥'
                };
                const layout = { title: '–ú—ñ—Å—è—á–Ω–∏–π –î–æ—Ö—ñ–¥', margin: { t: 30, b: 50, l: 50, r: 50 } };
                Plotly.newPlot('chart-monthly-revenue', [trace], layout, { responsive: true, displayModeBar: false });

            } catch (error) {
                document.getElementById('chart-monthly-revenue').innerHTML = `<p class="error">–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è: ${error.message}</p>`;
            }
        }

        async function renderDeveloperRevenueChart(year, topN) {
            const params = new URLSearchParams({ year: year, top_n: topN });
            const endpoint = `${API_BASE_URL}dev-revenue/?${params.toString()}`;

            document.getElementById('chart-dev-revenue').innerHTML = '';

            try {
                const response = await fetch(endpoint);
                const data = await response.json();

                const developers = data.developer_data.map(d => d.name);
                const revenue = data.developer_data.map(d => parseFloat(d.total_revenue));

                const trace = {
                    x: revenue,
                    y: developers,
                    type: 'bar',
                    orientation: 'h',
                    marker: { color: '#4caf50' },
                };

                const layout = { title: '–¢–æ–ø –†–æ–∑—Ä–æ–±–Ω–∏–∫—ñ–≤ –∑–∞ –î–æ—Ö–æ–¥–æ–º', yaxis: { autorange: 'reversed', automargin: true }, margin: { t: 30, l: 150, r: 50, b: 50 } };
                Plotly.newPlot('chart-dev-revenue', [trace], layout, { responsive: true, displayModeBar: false });

            } catch (error) {
                document.getElementById('chart-dev-revenue').innerHTML = `<p class="error">–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è: ${error.message}</p>`;
            }
        }

        async function renderWhalesCharts(year, topN, userIdFilter = '') {
            const params = new URLSearchParams({
                year: year,
                top_n: topN,
                user_ids: userIdFilter
            });
            const endpoint = `${API_BASE_URL}whales-analysis/?${params.toString()}`;

            const spendingChartId = 'chart-whales-spending';
            const genreChartId = 'chart-whales-genre';

            document.getElementById(spendingChartId).innerHTML = '';
            document.getElementById(genreChartId).innerHTML = '';

            try {
                const response = await fetch(endpoint);
                const data = await response.json();

                const usernames = data.spending_rank.map(item => item.username);
                const spending = data.spending_rank.map(item => parseFloat(item.total_spent));
                const rawData = data.spending_rank;

                const traceRank = { x: spending, y: usernames, type: 'bar', orientation: 'h', marker: { color: '#2196f3' } };
                const layoutRank = { title: `–¢–æ–ø ${topN} –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤ (${year || '–í—Å—ñ –†–æ–∫–∏'})`, yaxis: { autorange: 'reversed' }, margin: { t: 30, l: 150, r: 50, b: 50 } };

                Plotly.newPlot(spendingChartId, [traceRank], layoutRank, { responsive: true, displayModeBar: false });

                document.getElementById(spendingChartId).on('plotly_click', function(clickData){
                    if (clickData.points.length > 0) {
                        const pointIndex = clickData.points[0].pointIndex;
                        const userId = rawData[pointIndex].id;
                        renderWhalesCharts(year, topN, userId);
                    }
                });

                const genres = data.genre_breakdown.map(item => item.genre_name);
                const genreSpending = data.genre_breakdown.map(item => parseFloat(item.spent_on_genre));

                const traceGenre = [{ values: genreSpending, labels: genres, type: 'pie', hole: .4 }];
                const layoutGenre = { title: '–†–æ–∑–±–∏–≤–∫–∞ –ñ–∞–Ω—Ä—ñ–≤', margin: { t: 30, b: 30, l: 10, r: 10 } };

                Plotly.newPlot(genreChartId, traceGenre, layoutGenre, { responsive: true, displayModeBar: false });

            } catch (error) {
                document.getElementById(spendingChartId).innerHTML = `<p class="error">–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è: ${error.message}</p>`;
                document.getElementById(genreChartId).innerHTML = `<p class="error">–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è: ${error.message}</p>`;
            }
        }

        async function renderUserActivityChart(minPlaytime, topN) {
            const params = new URLSearchParams({ min_playtime: minPlaytime, top_n: topN });
            const endpoint = `${API_BASE_URL}user-activity/?${params.toString()}`;

            document.getElementById('chart-user-activity').innerHTML = '';

            try {
                const response = await fetch(endpoint);
                const data = await response.json();

                const chartData = data.activity_data;

                const trace = {
                    x: chartData.map(d => parseFloat(d.games_owned)),
                    y: chartData.map(d => parseFloat(d.total_playtime)),
                    text: chartData.map(d => d.username),
                    mode: 'markers',
                    type: 'scatter',
                    marker: { size: 10, color: '#00bcd4' },
                };

                const layout = { title: '–ê–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å: –Ü–≥—Ä–∏ vs. –ß–∞—Å –ì—Ä–∏', xaxis: { title: '–ö—ñ–ª—å–∫—ñ—Å—Ç—å –ü—Ä–∏–¥–±–∞–Ω–∏—Ö –Ü–≥–æ—Ä' }, yaxis: { title: '–ß–∞—Å –ì—Ä–∏ (–≥–æ–¥–∏–Ω–∏)' }, margin: { t: 30, b: 50, l: 50, r: 50 } };
                Plotly.newPlot('chart-user-activity', [trace], layout, { responsive: true, displayModeBar: false });

            } catch (error) {
                document.getElementById('chart-user-activity').innerHTML = `<p class="error">–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è: ${error.message}</p>`;
            }
        }

        async function renderGenrePlaytimeChart(minGames) {
            const params = new URLSearchParams({ min_unique_games: minGames });
            const endpoint = `${API_BASE_URL}genre-playtime/?${params.toString()}`;

            document.getElementById('chart-genre-playtime').innerHTML = '';

            try {
                const response = await fetch(endpoint);
                const data = await response.json();

                const genres = data.time_series_data.map(d => d.name);
                const avgPlaytime = data.time_series_data.map(d => parseFloat(d.avg_playtime_per_copy));

                const trace = {
                    x: avgPlaytime,
                    y: genres,
                    type: 'bar',
                    orientation: 'h',
                    marker: { color: '#ff9800' }
                };
                const layout = { title: '–°–µ—Ä. –ß–∞—Å –ì—Ä–∏ –∑–∞ –ñ–∞–Ω—Ä–∞–º–∏', yaxis: { autorange: 'reversed', automargin: true }, margin: { t: 30, l: 150, r: 50, b: 50 } };
                Plotly.newPlot('chart-genre-playtime', [trace], layout, { responsive: true, displayModeBar: false });

            } catch (error) {
                document.getElementById('chart-genre-playtime').innerHTML = `<p class="error">–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è: ${error.message}</p>`;
            }
        }

        function prepareTopRatedChartData(seriesData, topN) {
            const limit = parseInt(topN) > 0 ? parseInt(topN) : 10;
            const topGames = seriesData.slice(0, limit);

            const titles = topGames.map(item => item.title);
            const ratings = topGames.map(item => parseFloat(item.avg_rating).toFixed(2));
            const prices = topGames.map(item => parseFloat(item.price));

            return { titles, ratings, prices };
        }

        function renderTRGRatingChart(titles, ratings, topN) {
            const trace = {
                x: titles,
                y: ratings,
                type: 'bar',
                name: '–°–µ—Ä–µ–¥–Ω—ñ–π –†–µ–π—Ç–∏–Ω–≥',
                marker: { color: 'rgba(255, 152, 0, 0.8)' },
                hovertemplate: '<b>–ì—Ä–∞:</b> %{x}<br><b>–†–µ–π—Ç–∏–Ω–≥:</b> %{y}'
            };
            const layout = {
                title: `–¢–æ–ø-${topN} –Ü–≥–æ—Ä –∑–∞ –°–µ—Ä–µ–¥–Ω—ñ–º –†–µ–π—Ç–∏–Ω–≥–æ–º`,
                yaxis: { title: '–†–µ–π—Ç–∏–Ω–≥ (1.0-5.0)', range: [3.0, 5.0] },
                xaxis: { title: '–ì—Ä–∞', automargin: true },
                margin: { t: 50, b: 150 },
            };
            Plotly.newPlot('chart-top-rated-ranking', [trace], layout, { responsive: true, displayModeBar: false });
        }

        function renderTRGPricePieChart(prices) {
            const priceBins = {
                '–î–µ—à–µ–≤—ñ (–¥–æ $25.00)': 0,
                '–°–µ—Ä–µ–¥–Ω—ñ ($25.01 - $50.00)': 0,
                '–î–æ—Ä–æ–≥—ñ (>$50.00)': 0
            };
            const freeCount = prices.filter(price => price === 0).length;
            const paidPrices = prices.filter(price => price > 0);

            paidPrices.forEach(price => {
                if (price <= 25) {
                    priceBins['–î–µ—à–µ–≤—ñ (–¥–æ $25.00)']++;
                } else if (price <= 50) {
                    priceBins['–°–µ—Ä–µ–¥–Ω—ñ ($25.01 - $50.00)']++;
                } else {
                    priceBins['–î–æ—Ä–æ–≥—ñ (>$50.00)']++;
                }
            });

            const labels = [];
            const values = [];

            if (freeCount > 0) {
                 labels.push('–ë–µ–∑–∫–æ—à—Ç–æ–≤–Ω—ñ ($0.00)');
                 values.push(freeCount);
            }

            for (const [label, count] of Object.entries(priceBins)) {
                if (count > 0) {
                    labels.push(label);
                    values.push(count);
                }
            }

            if (values.length === 0) {
                Plotly.purge('chart-top-rated-price');
                document.getElementById('chart-top-rated-price').innerHTML = '<p style="text-align: center; color: #888; padding-top: 100px;">–ù–µ–º–∞—î –¥–∞–Ω–∏—Ö –ø—Ä–æ —Ü—ñ–Ω–æ–≤–∏–π —Ä–æ–∑–ø–æ–¥—ñ–ª.</p>';
                return;
            }

            const data = [{
                values: values,
                labels: labels,
                type: 'pie',
                hole: .4,
                hovertemplate: '%{label}<br><b>–ö—ñ–ª—å–∫—ñ—Å—Ç—å:</b> %{value} (%{percent})<extra></extra>'
            }];

            const layout = {
                title: '–¶—ñ–Ω–æ–≤–∏–π –†–æ–∑–ø–æ–¥—ñ–ª (–Ü–≥—Ä–∏ —É –¢–æ–ø-N)',
                margin: { t: 50, b: 50, l: 50, r: 50 }
            };

            Plotly.newPlot('chart-top-rated-price', data, layout, { responsive: true, displayModeBar: false });
        }


        async function renderTopRatedGamesCharts(minReviews, genre, minPrice, maxPrice, topN) {
            const params = new URLSearchParams({
                min_reviews: minReviews,
                genre: genre,
                min_price: minPrice,
                max_price: maxPrice
            });
            const endpoint = `${API_BASE_URL}top-rated-games/?${params.toString()}`;

            const rankingChartId = 'chart-top-rated-ranking';
            const priceChartId = 'chart-top-rated-price';

            document.getElementById(rankingChartId).innerHTML = '';
            document.getElementById(priceChartId).innerHTML = '';

            try {
                const response = await fetch(endpoint);
                const data = await response.json();

                const chartData = prepareTopRatedChartData(data.time_series_data, topN);

                renderTRGRatingChart(chartData.titles, chartData.ratings, chartData.titles.length);

                renderTRGPricePieChart(chartData.prices);

            } catch (error) {
                document.getElementById(rankingChartId).innerHTML = `<p class="error">–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è: ${error.message}</p>`;
                document.getElementById(priceChartId).innerHTML = `<p class="error">–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è: ${error.message}</p>`;
            }
        }

        window.onload = () => {
            populateGenreDropdown();
            fetchAllDataAndRender();
        };
    </script>
</body>
</html>