<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <title>–Ü–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∏–π –ê–Ω–∞–ª—ñ—Ç–∏—á–Ω–∏–π –î–∞—à–±–æ—Ä–¥ V2 (Bokeh)</title>
    <link rel="stylesheet" href="https://cdn.bokeh.org/bokeh/release/bokeh-3.8.1.min.css" type="text/css" />
   <script src="https://cdn.bokeh.org/bokeh/release/bokeh-3.8.1.min.js" crossorigin="anonymous"></script>
<script src="https://cdn.bokeh.org/bokeh/release/bokeh-widgets-3.8.1.min.js" crossorigin="anonymous"></script>
<script src="https://cdn.bokeh.org/bokeh/release/bokeh-tables-3.8.1.min.js" crossorigin="anonymous"></script>

    <style>
        body { font-family: Arial, sans-serif; background-color: #f4f7f9; padding: 20px; }
        .container { max-width: 1700px; margin: 0 auto; background: #fff; padding: 30px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); }
        h1 { color: #333; text-align: center; margin-bottom: 30px; }

        .controls-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px; margin-bottom: 30px; padding: 15px; background: #fafafa; border-radius: 4px;
        }
        .controls-grid div { display: flex; flex-direction: column; }
        .controls-grid label { font-weight: bold; color: #555; margin-bottom: 5px;}
        .controls-grid input, .controls-grid select { padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
        .controls-grid button { padding: 8px 15px; background-color: #ff9800; color: white; border: none; border-radius: 4px; cursor: pointer; transition: background-color 0.3s; margin-top: auto; }
        .controls-grid button:hover { background-color: #e65100; }

        .chart-layout {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        .chart-box {
            background: #fff;
            padding: 10px;
            border: 1px solid #eee;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            min-height: 450px;
            position: relative;
        }
        .chart-full-width {
            grid-column: 1 / -1;
        }
        .loading-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #888;
        }
    </style>
</head>
<body>

    <div class="container">
        <h1>üìà –Ü–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∏–π –ê–Ω–∞–ª—ñ—Ç–∏—á–Ω–∏–π –î–∞—à–±–æ—Ä–¥ V2</h1>

        <div class="controls-grid">
            <div><label for="start_date">–ú—ñ—Å—è—á–Ω–∏–π –î–æ—Ö—ñ–¥ (–ó):</label><input type="date" id="start_date"></div>
            <div><label for="end_date">–ú—ñ—Å—è—á–Ω–∏–π –î–æ—Ö—ñ–¥ (–î–æ):</label><input type="date" id="end_date"></div>
            <div><label for="year_filter">–†—ñ–∫ (–î–æ—Ö—ñ–¥/–í–∏—Ç—Ä–∞—Ç–∏):</label><input type="number" id="year_filter" placeholder="–†—ñ–∫" min="2020"></div>
            <div><label for="top_n_filter">Top N (–†–æ–∑—Ä./–ê–∫—Ç–∏–≤.):</label><input type="number" id="top_n_filter" value="10" min="1"></div>
            <div><label for="min_playtime">–ú—ñ–Ω. –ß–∞—Å –ì—Ä–∏ (–≥–æ–¥):</label><input type="number" id="min_playtime" value="0" min="0"></div>

            <div><label for="min_games_count">–ú—ñ–Ω. –Ü–≥–æ—Ä —É –ñ–∞–Ω—Ä—ñ:</label><input type="number" id="min_games_count" value="5" min="1"></div>

            <div><label for="trg_genre_name">–ñ–∞–Ω—Ä (–¢–æ–ø –Ü–≥–æ—Ä):</label><select id="trg_genre_name"><option value="">–í—Å—ñ –ñ–∞–Ω—Ä–∏</option></select></div>
            <div><label for="min_reviews">–ú—ñ–Ω. –í—ñ–¥–≥—É–∫—ñ–≤:</label><input type="number" id="min_reviews" value="10" min="1"></div>
            <div><label for="min_price">–ú—ñ–Ω. –¶—ñ–Ω–∞:</label><input type="number" id="min_price" min="0" step="0.01" placeholder="0"></div>
            <div><label for="max_price">–ú–∞–∫—Å. –¶—ñ–Ω–∞:</label><input type="number" id="max_price" min="0" step="0.01" placeholder="50"></div>

            <button onclick="fetchAllBokehCharts()">–û–Ω–æ–≤–∏—Ç–∏ –í—Å—ñ –ì—Ä–∞—Ñ—ñ–∫–∏</button>
        </div>

        <div class="chart-layout">
            <div class="chart-box chart-full-width" id="chart-monthly-revenue-bokeh"><div class="loading-text">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –ú—ñ—Å—è—á–Ω–æ–≥–æ –î–æ—Ö–æ–¥—É...</div></div>

            <div class="chart-box" id="chart-dev-revenue-bokeh"><div class="loading-text">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –î–æ—Ö–æ–¥—É –†–æ–∑—Ä–æ–±–Ω–∏–∫—ñ–≤...</div></div>

            <div class="chart-box" id="chart-genre-playtime-bokeh"><div class="loading-text">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –ß–∞—Å—É –ì—Ä–∏ –∑–∞ –ñ–∞–Ω—Ä–∞–º–∏...</div></div>

            <div class="chart-box chart-full-width" id="chart-top-rated-games-bokeh"><div class="loading-text">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –¢–æ–ø –Ü–≥–æ—Ä...</div></div>

            <div class="chart-box chart-full-width" id="chart-whales-analysis-bokeh"><div class="loading-text">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –ê–Ω–∞–ª—ñ–∑—É "–ö–∏—Ç—ñ–≤"...</div></div>

            <div class="chart-box chart-full-width" id="chart-user-activity-bokeh"><div class="loading-text">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—ñ –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤...</div></div>

        </div>
    </div>

    <script>
        const API_BASE_URL = '/api/reports/';

        const ALL_GENRES = [
            "Action", "RPG", "Strategy", "Simulation", "Puzzle",
            "Horror", "Sports", "Adventure", "Indie", "MMO", "Platformer",
            "Survival", "Rogue-like"
        ];

        function populateGenreDropdown() {
            const selectElement = document.getElementById('trg_genre_name');
            ALL_GENRES.forEach(genre => {
                const option = document.createElement('option');
                option.value = genre;
                option.textContent = genre;
                selectElement.appendChild(option);
            });
        }

async function fetchAndRenderBokehChart(endpointSuffix, containerId, params) {
    const container = document.getElementById(containerId);
    container.innerHTML = `<div class="loading-text">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</div>`;

    const url = `${API_BASE_URL}${endpointSuffix}/?${new URLSearchParams(params).toString()}`;

    try {
        const response = await fetch(url);
        if (!response.ok) {
            throw new Error(`HTTP Error! Status: ${response.status}`);
        }
        const data = await response.json();

        container.innerHTML = data.div;

        const scriptRegex = /<script\b[^>]*>([\s\S]*?)<\/script>/m;
        const match = data.script.match(scriptRegex);

        if (match && match[1]) {
            const script = document.createElement('script');
            script.type = 'text/javascript';
            script.text = match[1];
            container.appendChild(script);
        } else {
            const script = document.createElement('script');
            script.type = 'text/javascript';
            script.text = data.script;
            container.appendChild(script);
        }

    } catch (error) {
        console.error(`–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –≥—Ä–∞—Ñ—ñ–∫—É ${containerId}:`, error);
        container.innerHTML = `<div class="loading-text" style="color:red;">–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö: ${error.message}</div>`;
    }
}
        async function fetchAllBokehCharts() {
            const year = document.getElementById('year_filter').value;
            const topN = document.getElementById('top_n_filter').value;
            const startDate = document.getElementById('start_date').value;
            const endDate = document.getElementById('end_date').value;
            const minGames = document.getElementById('min_games_count').value;
            const minPlaytime = document.getElementById('min_playtime').value;

            const minReviews = document.getElementById('min_reviews').value;
            const trgGenre = document.getElementById('trg_genre_name').value;
            const minPrice = document.getElementById('min_price').value;
            const maxPrice = document.getElementById('max_price').value;

            await Promise.all([
                fetchAndRenderBokehChart('monthly-revenue-bokeh', 'chart-monthly-revenue-bokeh', {
                    start_date: startDate,
                    end_date: endDate
                }),

                fetchAndRenderBokehChart('developer-revenue-bokeh', 'chart-dev-revenue-bokeh', {
                    year: year,
                    top_n: topN
                }),

                fetchAndRenderBokehChart('genre-playtime-bokeh', 'chart-genre-playtime-bokeh', {
                    min_unique_games: minGames
                }),

                fetchAndRenderBokehChart('top-rated-games-bokeh', 'chart-top-rated-games-bokeh', {
                    min_reviews: minReviews,
                    genre: trgGenre,
                    min_price: minPrice,
                    max_price: maxPrice,
                    top_n: topN

                }),

                fetchAndRenderBokehChart('whales-analysis-bokeh', 'chart-whales-analysis-bokeh', {
                    year: year,
                    top_n: topN
                }),

                fetchAndRenderBokehChart('user-activity-bokeh', 'chart-user-activity-bokeh', {
                    min_playtime: minPlaytime,
                    top_n: topN
                })
            ]);

            console.log("–£—Å—ñ –≥—Ä–∞—Ñ—ñ–∫–∏ Bokeh –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ.");
        }
        window.onload = () => {
            populateGenreDropdown();
            fetchAllBokehCharts();
        };
    </script>
</body>
</html>