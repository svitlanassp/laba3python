<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <title>Звіт: Дохід Розробників</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; background-color: #f4f7f9; padding: 20px; }
        .container { max-width: 1400px; margin: 0 auto; background: #fff; padding: 30px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); }
        h1 { color: #333; text-align: center; margin-bottom: 30px; }

        .kpi-container { display: flex; justify-content: space-around; margin-bottom: 30px; flex-wrap: wrap; }
        .kpi-card {
            background: #e8f5e9; border-left: 5px solid #4caf50; padding: 15px; border-radius: 4px;
            text-align: center; flex: 1; min-width: 180px; margin: 5px 10px;
        }
        .kpi-card h3 { margin: 0 0 5px; font-size: 1.1em; color: #2e7d32; }
        .kpi-value { font-size: 1.8em; font-weight: bold; color: #4caf50; }

        .controls { display: flex; flex-wrap: wrap; justify-content: center; gap: 20px; margin-bottom: 30px; padding: 15px; background: #fafafa; border-radius: 4px; }
        .controls label { font-weight: bold; color: #555; }
        .controls input { padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
        .controls button { padding: 8px 15px; background-color: #4caf50; color: white; border: none; border-radius: 4px; cursor: pointer; transition: background-color 0.3s; }
        .controls button:hover { background-color: #388e3c; }

        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #ddd; padding: 10px; text-align: left; }
        th { background-color: #f2f2f2; font-weight: bold; color: #333; }
        .chart-container { height: 450px; margin-bottom: 30px; }
    </style>
</head>
<body>

    <div class="container">
        <h1 id="report-title">Звіт: Дохід Розробників (Завантаження...)</h1>

        <div class="controls">
            <div>
                <label for="year">Рік (опц.):</label>
                <input type="number" id="year" placeholder="2024" min="2020" max="2030">
            </div>
            <div>
                <label for="top_n">Top N (для графіка):</label>
                <input type="number" id="top_n" value="10" min="1" max="50">
            </div>
            <button onclick="fetchDataAndRender()">Завантажити</button>
        </div>

        <div class="kpi-container">
            <div class="kpi-card">
                <h3>Загальна Кількість Розробників</h3>
                <div id="kpi-total-developers" class="kpi-value">...</div>
            </div>
            <div class="kpi-card">
                <h3>Середній Дохід</h3>
                <div id="kpi-mean-revenue" class="kpi-value">...</div>
            </div>
            <div class="kpi-card">
                <h3>Медіана Доходу</h3>
                <div id="kpi-median-revenue" class="kpi-value">...</div>
            </div>
            <div class="kpi-card">
                <h3>Макс. Дохід</h3>
                <div id="kpi-max-revenue" class="kpi-value">...</div>
            </div>

            <div class="kpi-card">
                <h3>Мін. Дохід</h3>
                <div id="kpi-min-revenue" class="kpi-value">...</div>
            </div>

            <div class="kpi-card">
                <h3>Середня Ціна Продажу</h3>
                <div id="kpi-avg-price-mean" class="kpi-value">...</div>
            </div>
        </div>

        <h2>Топ Розробників за Доходом</h2>
        <div class="chart-container">
            <div id="revenueBarChart"></div>
        </div>

        <h2>Деталізація Даних</h2>
        <div id="developerTableContainer">
            </div>

    </div>

    <script>
        const API_BASE_URL = 'http://127.0.0.1:8000/api/reports/';

        function formatCurrency(amount) {
            return new Intl.NumberFormat('uk-UA', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: 2
            }).format(amount);
        }
        function formatInteger(num) {
            return num.toLocaleString('uk-UA');
        }

        async function fetchDataAndRender() {
            const year = document.getElementById('year').value;
            const topN = document.getElementById('top_n').value;

            const params = new URLSearchParams({
                year: year,
                top_n: topN
            });

            const endpoint = `${API_BASE_URL}dev-revenue/?${params.toString()}`;

            document.getElementById('report-title').innerText = "Завантаження...";
            updateKPIs({});
            document.getElementById('developerTableContainer').innerHTML = 'Завантаження...';


            try {
                const response = await fetch(endpoint);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();

                document.getElementById('report-title').innerText = data.report_name;

                updateKPIs(data.analytics_stats);

                renderRevenueBarChart(data.developer_data);

                renderDeveloperTable(data.developer_data);

            } catch (error) {
                console.error("Помилка завантаження даних:", error);
                document.getElementById('report-title').innerText = `Помилка завантаження: ${error.message}`;
            }
        }

        function updateKPIs(stats) {
            const meanRev = stats.mean_revenue || 0;
            const medianRev = stats.median_revenue || 0;
            const maxRev = stats.max_revenue || 0;
            const minRev = stats.min_revenue || 0;
            const avgPriceMean = stats.avg_price_mean || 0;
            const totalDevs = stats.total_developers_count || 0;

            document.getElementById('kpi-total-developers').innerText = formatInteger(totalDevs);
            document.getElementById('kpi-mean-revenue').innerText = formatCurrency(meanRev);
            document.getElementById('kpi-median-revenue').innerText = formatCurrency(medianRev);
            document.getElementById('kpi-max-revenue').innerText = formatCurrency(maxRev);
            document.getElementById('kpi-avg-price-mean').innerText = formatCurrency(avgPriceMean);

            document.getElementById('kpi-min-revenue').innerText = totalDevs > 0 ? formatCurrency(minRev) : formatCurrency(0);
        }

        function renderRevenueBarChart(developerData) {
            if (!developerData || developerData.length === 0) {
                Plotly.purge('revenueBarChart');
                document.getElementById('revenueBarChart').innerHTML = '<p style="text-align: center; color: #888; padding-top: 100px;">Немає даних для відображення графіка.</p>';
                return;
            }

            const developers = developerData.map(d => d.name);
            const revenue = developerData.map(d => parseFloat(d.total_revenue));
            const copies = developerData.map(d => d.total_copies_sold);

            const trace = {
                x: revenue,
                y: developers,
                text: copies,
                type: 'bar',
                orientation: 'h',
                marker: { color: '#4caf50' },
                hovertemplate:
                    '<b>Розробник:</b> %{y}<br>' +
                    '<b>Дохід:</b> %{x:$,.2f}<br>' +
                    '<b>Копій продано:</b> %{text}<extra></extra>'
            };

            const layout = {
                title: false,
                xaxis: { title: 'Загальний Дохід ($)', tickprefix: '$' },
                yaxis: {
                    title: 'Розробник',
                    autorange: 'reversed',
                    automargin: true
                },
                margin: { t: 30, l: 150, r: 50, b: 50 },
            };

            Plotly.newPlot('revenueBarChart', [trace], layout, { responsive: true, displayModeBar: false });
        }

        function renderDeveloperTable(developerData) {
            const container = document.getElementById('developerTableContainer');
            if (!developerData || developerData.length === 0) {
                container.innerHTML = '<p style="text-align: center;">Немає даних для таблиці.</p>';
                return;
            }

            let html = '<table><thead><tr>';
            html += '<th>#</th>';
            html += '<th>Розробник</th>';
            html += '<th style="text-align: right;">Дохід</th>';
            html += '<th style="text-align: right;">Копій Продано</th>';
            html += '<th style="text-align: right;">Сер. Ціна Продажу</th>';
            html += '</tr></thead><tbody>';

            developerData.forEach((dev, index) => {
                html += `<tr>`;
                html += `<td>${index + 1}</td>`;
                html += `<td>${dev.name}</td>`;
                html += `<td style="text-align: right;">${formatCurrency(dev.total_revenue)}</td>`;
                html += `<td style="text-align: right;">${formatInteger(dev.total_copies_sold)}</td>`;
                html += `<td style="text-align: right;">${formatCurrency(dev.avg_price)}</td>`;
                html += `</tr>`;
            });

            html += '</tbody></table>';
            container.innerHTML = html;
        }

        window.onload = fetchDataAndRender;
    </script>
</body>
</html>