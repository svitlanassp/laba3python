<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <title>Аналіз "Китів" (Whales Analysis)</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; background-color: #f4f7f9; padding: 20px; }
        .container { max-width: 1400px; margin: 0 auto; background: #fff; padding: 30px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); }
        h1 { color: #333; text-align: center; margin-bottom: 30px; }
        .kpi-container { display: flex; justify-content: space-around; margin-bottom: 30px; }
        .kpi-card { background: #e3f2fd; border-left: 5px solid #2196f3; padding: 15px; border-radius: 4px; text-align: center; flex: 1; margin: 0 10px; }
        .kpi-card h3 { margin: 0 0 5px; font-size: 1.1em; color: #1565c0; }
        .kpi-value { font-size: 2em; font-weight: bold; color: #2196f3; }
        .controls { display: flex; flex-wrap: wrap; justify-content: center; gap: 20px; margin-bottom: 30px; padding: 15px; background: #fafafa; border-radius: 4px; }
        .controls label { font-weight: bold; color: #555; }
        .controls input, .controls select { padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
        .controls button { padding: 8px 15px; background-color: #2196f3; color: white; border: none; border-radius: 4px; cursor: pointer; transition: background-color 0.3s; }
        .controls button:hover { background-color: #1e88e5; }
        .chart-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; }
        .chart-container { height: 400px; }
    </style>
</head>
<body>

    <div class="container">
        <h1 id="report-title">Аналіз "Китів" (Завантаження...)</h1>

        <div class="controls">
            <div>
                <label for="year">Рік (опц.):</label>
                <input type="number" id="year" placeholder="2024" min="2020" max="2030">
            </div>
            <div>
                <label for="top_n">Кількість Top N:</label>
                <input type="number" id="top_n" value="10" min="5" max="50">
            </div>
            <input type="hidden" id="selected_user_id" value="">

            <button onclick="fetchDataAndRender()">Оновити</button>
            <button onclick="resetUserFilter()" id="resetButton" style="display:none; background-color: #f44336;">Скинути Фільтр Користувача</button>
        </div>

        <div class="kpi-container">
            <div class="kpi-card">
                <h3>Загальні Витрати (Top N)</h3>
                <div id="kpi-total-spending" class="kpi-value">...</div>
            </div>
            <div class="kpi-card">
                <h3>Середні Витрати на Користувача</h3>
                <div id="kpi-avg-spending" class="kpi-value">...</div>
            </div>
            <div class="kpi-card">
                <h3>Загальна Кількість Замовлень</h3>
                <div id="kpi-total-orders" class="kpi-value">...</div>
            </div>
        </div>

        <div class="chart-grid">
            <div class="chart-container">
                <div id="spendingRankChart"></div>
                <p style="text-align: center; font-style: italic;">Натисніть на стовпчик користувача, щоб побачити його особисту розбивку жанрів.</p>
            </div>
            <div class="chart-container">
                <h3 id="genreBreakdownTitle" style="text-align: center;">Розбивка Витрат "Китів" за Жанрами (Всі Топ N)</h3>
                <div id="genreBreakdownChart"></div>
            </div>
        </div>
    </div>

<script>
    const API_BASE_URL = '/api/reports/';
    let currentRankData = [];

    function formatCurrency(amount) {
        return new Intl.NumberFormat('uk-UA', {
            style: 'currency',
            currency: 'USD',
            minimumFractionDigits: 2
        }).format(amount);
    }

    function formatNumber(amount) {
        return new Intl.NumberFormat('uk-UA').format(amount);
    }

    function filterByUser(userId) {
        document.getElementById('selected_user_id').value = userId;
        document.getElementById('resetButton').style.display = 'inline-block';
        fetchDataAndRender();
    }

    function resetUserFilter() {
        document.getElementById('selected_user_id').value = '';
        document.getElementById('resetButton').style.display = 'none';
        fetchDataAndRender();
    }

    async function fetchDataAndRender() {
        const year = document.getElementById('year').value;
        const topN = document.getElementById('top_n').value;
        const userIdFilter = document.getElementById('selected_user_id').value;

        const params = new URLSearchParams({
            year: year,
            top_n: topN,
            user_ids: userIdFilter
        });

        const endpoint = `${API_BASE_URL}whales-analysis/?${params.toString()}`;

        document.getElementById('report-title').innerText = "Завантаження...";
        updateKPIs({});

        try {
            const response = await fetch(endpoint);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const data = await response.json();

            document.getElementById('report-title').innerText = data.report_name;

            currentRankData = data.spending_rank;

            updateKPIs(data.analytics_stats);

            const spendingData = prepareSpendingData(data.spending_rank);
            const genreData = prepareGenreData(data.genre_breakdown);
            renderSpendingRankChart(spendingData.usernames, spendingData.spending, data.spending_rank);

            updateGenreBreakdownTitle(userIdFilter);
            renderGenreBreakdownChart(genreData.genres, genreData.spending);

        } catch (error) {
            console.error("Помилка завантаження даних:", error);
            document.getElementById('report-title').innerText = `Помилка завантаження: ${error.message}`;
        }
    }

    function prepareSpendingData(rankList) {
        const usernames = rankList.map(item => item.username);
        const spending = rankList.map(item => parseFloat(item.total_spent));
        return { usernames, spending };
    }


    function prepareGenreData(genreList) {
        const genres = genreList.map(item => item.genre_name);
        const spending = genreList.map(item => parseFloat(item.spent_on_genre));
        return { genres, spending };
    }

    function updateKPIs(stats) {
        const totalSpending = stats.total_spending_top_n || 0;
        const avgSpending = stats.avg_spending_per_user || 0;
        const totalOrders = stats.total_orders_top_n || 0;

        document.getElementById('kpi-total-spending').innerText = formatCurrency(totalSpending);
        document.getElementById('kpi-avg-spending').innerText = formatCurrency(avgSpending);
        document.getElementById('kpi-total-orders').innerText = formatNumber(totalOrders);
    }

    function updateGenreBreakdownTitle(userIdFilter) {
        const titleElement = document.getElementById('genreBreakdownTitle');
        if (userIdFilter) {
            const user = currentRankData.find(u => u.id == userIdFilter);
            const username = user ? user.username : 'Вибраного Користувача';
            titleElement.innerText = `Розбивка Витрат для: ${username}`;
        } else {
            titleElement.innerText = 'Розбивка Витрат "Китів" за Жанрами (Всі Топ N)';
        }
    }

    function renderSpendingRankChart(usernames, spending, rawData) {
        const trace = {
            x: spending,
            y: usernames,
            type: 'bar',
            orientation: 'h',
            name: 'Витрачено ($)',
            marker: { color: '#2196f3' },
            hovertemplate: '<b>Користувач:</b> %{y}<br><b>Витрати:</b> %{x:$.2f}<extra></extra>'
        };
        const layout = {
            title: 'Топ Користувачів за Витратами',
            xaxis: { title: 'Витрати ($)', tickprefix: '$' },
            yaxis: { title: 'Користувач', autorange: 'reversed' },
            margin: { t: 50, l: 150, r: 50, b: 50 },
            height: 400
        };

        Plotly.newPlot('spendingRankChart', [trace], layout, { responsive: true, displayModeBar: false });

        const chartDiv = document.getElementById('spendingRankChart');
        chartDiv.on('plotly_click', function(data){
            if (data.points.length > 0) {
                const pointIndex = data.points[0].pointIndex;
                const userId = rawData[pointIndex].id;
                filterByUser(userId);
            }
        });
    }


function renderGenreBreakdownChart(genres, spending) {
    if (genres.length === 0 || spending.every(s => s === 0)) {
        Plotly.purge('genreBreakdownChart');
        const chartDiv = document.getElementById('genreBreakdownChart');
        chartDiv.innerHTML = '<p style="text-align: center; color: #888; padding-top: 100px;">Немає даних про витрати на жанри для вибраної групи/користувача.</p>';
        return;
    }

    const data = [{
        values: spending,
        labels: genres,
        type: 'pie',
        hole: .4,
        textinfo: 'none',
        marker: {
            // Використовуйте бажану схему кольорів
            colors: ['#2196f3', '#4CAF50', '#FFC107', '#FF5722', '#00BCD4', '#9C27B0', '#795548', '#FF9800', '#CDDC39', '#03A9F4']
        },
        hovertemplate:
            '<b>Жанр:</b> %{label}<br>' +
            '<b>Витрачено:</b> %{value:$.2f}<br>' +
            '<b>Частка:</b> %{percent}<extra></extra>'
    }];

    const layout = {
        title: false,

        margin: { t: 100, b: 50, l: 10, r: 10 },

        showlegend: true,
        legend: {
            orientation: "h",
            x: 0,
            y: 3.02,
            xanchor: "left"
        }
    };

    Plotly.newPlot('genreBreakdownChart', data, layout, { responsive: true, displayModeBar: false });
}

    window.onload = fetchDataAndRender;
</script>
</body>
</html>